// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ENUMS ==========

enum Role {
  CUSTOMER
  ADMIN
  STAFF
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PRODUCTION
  READY_FOR_PICKUP
  SHIPPING
  COMPLETED
  CANCELLED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentMethod {
  COD
  SEPAY
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

// ========== USER DOMAIN ==========

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  passwordHash String?
  role      Role     @default(CUSTOMER)
  provider  AuthProvider @default(EMAIL)
  providerId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile       Profile?
  addresses     Address[]
  measurements  Measurement[]
  ordersAsCustomer    Order[] @relation("CustomerOrders")
  ordersAsStaff       Order[] @relation("StaffOrders")
  appointments  Appointment[]
  appointmentsAsStaff Appointment[] @relation("StaffAppointments")
  reviews       Review[]

  @@index([email])
  @@index([role])
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  fullName  String
  phone     String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  street    String
  city      String
  country   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

model Measurement {
  id        String   @id @default(cuid())
  userId    String
  name      String   // e.g., "Số đo Vest", "Số đo Sơ mi"
  details   Json     // e.g., { "vai": 40, "nguc": 90, "eo": 70 }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

// ========== PRODUCT DOMAIN ==========

model Category {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  products Product[]
}

model Product {
  id          String   @id @default(cuid())
  categoryId  String
  name        String
  description String?
  basePrice   Decimal  @db.Decimal(10, 2)
  images      Json?    // Array of image URLs
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category      Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  fabrics       Fabric[]        @relation("ProductFabrics")
  styleOptions  StyleOption[]   @relation("ProductStyleOptions")
  orderItems    OrderItem[]
  reviews       Review[]

  @@index([categoryId])
  @@index([isPublished])
}

model Fabric {
  id               String   @id @default(cuid())
  name             String   @unique
  imageUrl         String?
  priceAdjustment  Decimal  @db.Decimal(10, 2) @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  products   Product[]  @relation("ProductFabrics")
  orderItems OrderItem[]

  @@index([name])
}

model StyleOption {
  id               String   @id @default(cuid())
  name             String
  type             String   // e.g., "Cổ áo", "Kiểu tay"
  priceAdjustment  Decimal  @db.Decimal(10, 2) @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  products   Product[]  @relation("ProductStyleOptions")
  orderItems OrderItem[]

  @@index([type])
}

// ========== ORDER DOMAIN ==========

model Order {
  id               String       @id @default(cuid())
  userId           String
  staffId          String?
  status           OrderStatus  @default(PENDING)
  totalAmount      Decimal      @db.Decimal(12, 2)
  shippingAddress  Json         // Snapshot of address at time of order
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  customer  User        @relation("CustomerOrders", fields: [userId], references: [id], onDelete: Cascade)
  staff     User?       @relation("StaffOrders", fields: [staffId], references: [id], onDelete: SetNull)
  items     OrderItem[]
  payment   Payment?
  review    Review?

  @@index([userId])
  @@index([staffId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id                   String   @id @default(cuid())
  orderId              String
  productId            String
  fabricId             String
  styleOptionId        String?
  quantity             Int      @default(1)
  priceAtTime          Decimal  @db.Decimal(12, 2)
  measurementSnapshot  Json     // Snapshot of measurement at time of order
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])
  fabric       Fabric       @relation(fields: [fabricId], references: [id])
  styleOption  StyleOption? @relation(fields: [styleOptionId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id            String         @id @default(cuid())
  orderId       String         @unique
  method        PaymentMethod  @default(COD)
  status        PaymentStatus  @default(PENDING)
  transactionId String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String
  orderId   String   @unique
  rating    Int      // 1-5 stars
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
}

// ========== APPOINTMENT DOMAIN ==========

model Appointment {
  id        String            @id @default(cuid())
  userId    String
  staffId   String?
  status    AppointmentStatus @default(PENDING)
  startTime DateTime
  endTime   DateTime
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  staff User? @relation("StaffAppointments", fields: [staffId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([staffId])
  @@index([status])
  @@index([startTime])
}
